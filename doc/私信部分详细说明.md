# 私信部分详细说明

本说明文档详细分析本项目后端关于私信（PrivateMessage）相关功能的实现机制，涵盖通信流程、文件间交互、前后端链路、全局异常处理与ApiResponse统一格式、各层次功能与通信过程。

---

## 1. 业务功能与场景

- 支持用户间一对一私信聊天，文本、图片、视频等多媒体消息。
- 支持会话历史查询、实时消息推送（SSE）。
- 限制非好友首次只能发送一条文本，需对方回复后才能继续。
- 支持消息发送权限校验。

---

## 2. 工作流程与层次结构

### 2.1 通信流程
- **前端**向`/api/messages`相关接口发起请求（REST或SSE）。
- **后端Controller**接收请求，参数校验，调用Service处理业务。
- **Service**封装业务逻辑，调用Repository持久化消息，必要时抛出业务异常。
- **Repository**负责与数据库交互，查询/保存消息。
- **Mapper**负责实体与DTO互转，避免实体泄漏到Controller。
- **EventPublisher**负责SSE实时推送。
- **全局异常处理器**统一捕获异常，返回ApiResponse格式响应。

### 2.2 主要文件
- `PrivateMessage.java`（model）：私信实体
- `PrivateMessageDTO.java`（dto）：前后端数据传输对象
- `PrivateMessageRepository.java`：数据访问层
- `PrivateMessageService.java`/`PrivateMessageServiceImpl.java`：业务逻辑层
- `PrivateMessageMapper.java`：实体与DTO转换
- `PrivateMessageController.java`/`PrivateMessageStreamController.java`：接口层
- `MessageEventPublisher.java`：SSE推送

---

## 3. 主要接口设计

### 3.1 发送文本消息
- **URL**：`POST /api/messages/text`
- **请求体**：
```json
{
  "receiverId": 2,
  "text": "你好！"
}
```
- **响应**：
```json
{
  "code": 200,
  "msg": "发送成功",
  "data": {
    "id": 123,
    "senderId": 1,
    "receiverId": 2,
    "text": "你好！",
    "type": "TEXT",
    "createdAt": "2025-11-28T12:34:56Z"
  }
}
```

### 3.2 发送多媒体消息
- **URL**：`POST /api/messages/media`
- **请求体**：
```json
{
  "receiverId": 2,
  "mediaUrl": "https://example.com/image.jpg",
  "type": "IMAGE",
  "text": "图片说明"
}
```
- **响应**：同上，type为"IMAGE"或"VIDEO"。

### 3.3 查询会话历史
- **URL**：`GET /api/messages/conversation?userId=2`
- **响应**：
```json
{
  "code": 200,
  "msg": "获取成功",
  "data": [
    {
      "id": 123,
      "senderId": 1,
      "receiverId": 2,
      "text": "你好！",
      "type": "TEXT",
      "createdAt": "2025-11-28T12:34:56Z"
    },
    {
      "id": 124,
      "senderId": 2,
      "receiverId": 1,
      "text": "你好！很高兴认识你。",
      "type": "TEXT",
      "createdAt": "2025-11-28T12:35:10Z"
    }
  ]
}
```

### 3.4 实时消息推送（SSE）
- **URL**：`GET /api/messages/stream?userId=2`
- **响应**：SSE流，事件名为`init`（初始历史），`update`（新消息）。

---

## 4. 前后端数据结构示例

### 4.1 DTO结构
```json
{
  "id": 123,
  "senderId": 1,
  "receiverId": 2,
  "text": "你好！",
  "mediaUrl": null,
  "type": "TEXT",
  "createdAt": "2025-11-28T12:34:56Z"
}
```

### 4.2 ApiResponse统一响应结构
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": null
}
```

---

## 5. 异常与统一响应
- 所有接口均返回`ApiResponse<T>`对象，包含`code`（状态码）、`msg`（提示信息）、`data`（数据）。
- 业务异常（如非好友首次只能发一条消息）会被全局异常处理器捕获，返回如下：
```json
{
  "code": 400,
  "msg": "非好友关系下仅允许发送一条文本，等待对方回复后才能继续。",
  "data": null
}
```
- 未知异常返回：
```json
{
  "code": 500,
  "msg": "服务器内部错误",
  "data": null
}
```

---

## 6. 典型流程示意

1. 用户A向用户B发送私信，前端调用`/api/messages/text`，后端校验权限、保存消息、推送SSE。
2. 用户A/B打开会话页面，前端调用`/api/messages/conversation`获取历史，或通过SSE实时接收新消息。
3. 非好友首次发消息，后端限制并返回业务异常，前端展示提示。

---

如需更详细的字段说明或扩展场景，请参考源码或联系开发者。
